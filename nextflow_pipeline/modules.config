/*
========================================================================================
    MODULES CONFIGURATION
========================================================================================
    Per-process settings including publishDir paths and additional arguments
----------------------------------------------------------------------------------------
*/

process {

    // -------------------------
    // Part 1: Core Processing
    // -------------------------

    withName: 'PBMM2_INDEX' {
        publishDir = [
            path: { "${params.outdir}/reference" },
            mode: 'copy',
            pattern: "*.mmi"
        ]
    }

    withName: 'PBMM2_ALIGN' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/01_aligned" },
            mode: 'copy',
            pattern: "*.{bam,bai}"
        ]
    }

    withName: 'SEQUENCING_QC' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/01_sequencing_qc" },
            mode: 'copy',
            pattern: "*.{pdf,xml}"
        ]
    }

    withName: 'FIBERTOOLS_ADD_NUCLEOSOMES' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/02_nucleosomes" },
            mode: 'copy',
            pattern: "*.ft.bam"
        ]
    }

    withName: 'SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/02_nucleosomes" },
            mode: 'copy',
            pattern: "*.{bai,pbi}"
        ]
    }

    withName: 'FIBERSEQ_QC' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/03_fiberseq_qc" },
            mode: 'copy',
            pattern: "qc_output/*"
        ]
    }

    withName: 'FIBERTOOLS_PILEUP' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/04_pileups" },
            mode: 'copy',
            pattern: "*.pileup.bed"
        ]
    }

    withName: 'PILEUP_TO_BEDGRAPH' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/04_pileups" },
            mode: 'copy',
            pattern: "*.bedgraph"
        ]
    }

    withName: 'BEDGRAPH_TO_BIGWIG' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/05_bigwigs" },
            mode: 'copy',
            pattern: "*.bw"
        ]
    }

    withName: 'COMPUTE_MATRIX' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/06_heatmaps" },
            mode: 'copy',
            pattern: "*.{matrix.gz,sorted_regions.bed}"
        ]
    }

    withName: 'PLOT_HEATMAP' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/06_heatmaps" },
            mode: 'copy',
            pattern: "*.{png,pdf}"
        ]
    }

    // -------------------------
    // Part 2: Advanced Analysis
    // -------------------------

    withName: 'SAMTOOLS_FILTER_CHROMS' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/07_filtered" },
            mode: 'copy',
            pattern: "*.{bam,bai}"
        ]
    }

    withName: 'KMER_PHASING' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/08_kmer_phasing" },
            mode: 'copy',
            pattern: "output/**"
        ]
    }

    withName: 'FIRE' {
        publishDir = [
            path: { "${params.outdir}/${sample_name}/09_fire" },
            mode: 'copy',
            pattern: "output/**"
        ]
    }
}
